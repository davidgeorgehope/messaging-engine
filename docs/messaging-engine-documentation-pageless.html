<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>PMM Messaging Engine Documentation</title>
  <style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}

ul.task-list[class]{list-style: none;}
ul.task-list li input[type="checkbox"] {
font-size: inherit;
width: 0.8em;
margin: 0 0.8em 0.2em -1.6em;
vertical-align: middle;
}
.display.math{display: block; text-align: center; margin: 0.5rem auto;}

pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
  <style type="text/css">img {
max-width: 100%;
height: auto;
display: block;
margin: 1em auto;
}
@page {
size: 210mm 2000mm;
margin: 1cm;
}
body {
font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
font-size: 11pt;
line-height: 1.6;
margin: 1cm;
}
h1 { font-size: 1.8em; }
h2 { font-size: 1.4em; }
h3 { font-size: 1.2em; }
pre, code {
font-size: 0.85em;
background: #f5f5f5;
padding: 2px 4px;
border-radius: 3px;
}
pre {
padding: 1em;
overflow-x: auto;
}
table {
border-collapse: collapse;
width: 100%;
font-size: 0.9em;
}
th, td {
border: 1px solid #ddd;
padding: 6px 10px;
text-align: left;
}
th {
background: #f0f0f0;
}
</style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">PMM Messaging Engine Documentation</h1>
</header>
<h1 id="pmm-messaging-engine-technical-documentation">PMM Messaging
Engine — Technical Documentation</h1>
<p><em>Comprehensive Architecture, Pipeline, and Prompt
Reference</em></p>
<hr />
<h2 id="executive-summary">1. Executive Summary</h2>
<p>The PMM Messaging Engine converts product documentation into scored,
quality-tested messaging assets through 5 specialized AI pipelines. It
follows an “outside-in” philosophy — starting with real practitioner
pain from developer communities rather than vendor features.</p>
<h3 id="key-capabilities">Key Capabilities</h3>
<ul>
<li><strong>5 distinct generation pipelines</strong> — Standard,
Outside-In (signature), Adversarial, Multi-Perspective, and Straight
Through</li>
<li><strong>Sequential DAG architecture</strong> — each pipeline step
feeds the next</li>
<li><strong>Shared refinement loop</strong> — score → deslop → refine
(up to 3x) with plateau detection</li>
<li><strong>Multi-model AI strategy</strong> — Gemini 3 Pro/Flash
(production) with test profile fallback</li>
<li><strong>5-dimension quality scoring</strong> with scorer health
tracking and degraded mode</li>
<li><strong>8 asset types</strong> from battlecards to narratives</li>
<li><strong>Voice profile system</strong> with per-voice quality
thresholds</li>
</ul>
<h3 id="tech-stack">Tech Stack</h3>
<table>
<colgroup>
<col style="width: 38%" />
<col style="width: 61%" />
</colgroup>
<thead>
<tr class="header">
<th>Layer</th>
<th>Technology</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Backend</td>
<td>Hono (REST API), TypeScript</td>
</tr>
<tr class="even">
<td>Frontend</td>
<td>Vite + React + Tailwind CSS</td>
</tr>
<tr class="odd">
<td>Database</td>
<td>SQLite + Drizzle ORM (14 tables)</td>
</tr>
<tr class="even">
<td>AI Models</td>
<td>Gemini 3 Pro/Flash (prod), Gemini 2.5 Flash (test), Claude
(opt-in)</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="system-architecture">2. System Architecture</h2>
<h3 id="file-structure">File Structure</h3>
<pre><code>src/
├── api/
│   ├── generate.ts              # ~186 lines — route definitions + re-exports only
│   ├── validation.ts            # Zod schemas for all endpoints
│   ├── index.ts                 # Hono app + route mounting
│   ├── middleware/
│   │   ├── auth.ts              # JWT authentication (hard error)
│   │   └── rate-limit.ts        # Per-IP HTTP rate limiting
│   ├── admin/                   # Admin CRUD (settings, voices, documents)
│   └── workspace/               # Session management, chat, actions
├── config.ts                    # Model profiles, env config
├── types/index.ts               # Shared interfaces (ScoringThresholds, PipelineStep, etc.)
├── services/
│   ├── pipeline/
│   │   ├── orchestrator.ts      # Job lifecycle, dispatch, generateAndScore, refinementLoop, storeVariant
│   │   ├── prompts.ts           # All prompt builders, templates, banned words
│   │   ├── evidence.ts          # EvidenceBundle, community/competitive research
│   │   └── pipelines/
│   │       ├── standard.ts      # PoV-first with deep extraction
│   │       ├── outside-in.ts    # Community pain-first (signature)
│   │       ├── adversarial.ts   # Attack/defend generation
│   │       ├── multi-perspective.ts  # 3 angles + synthesis
│   │       └── straight-through.ts   # Score-only, no generation
│   ├── quality/
│   │   ├── score-content.ts     # 5 parallel scorers + health tracking
│   │   ├── slop-detector.ts     # AI cliché detection
│   │   ├── vendor-speak.ts      # Marketing jargon scorer
│   │   ├── authenticity.ts      # Authenticity scorer
│   │   ├── specificity.ts       # Specificity scorer
│   │   ├── persona-critic.ts    # Persona fit scorer
│   │   └── grounding-validator.ts # Strips fabricated quotes
│   ├── ai/clients.ts            # Gemini + Claude API wrappers
│   ├── product/insights.ts      # Insight extraction + deep PoV
│   └── research/deep-research.ts # Gemini Deep Research agent
├── db/                          # Schema, connection, seed data
└── utils/                       # Logger, hash, retry</code></pre>
<h3 id="security">Security</h3>
<table>
<thead>
<tr class="header">
<th>Layer</th>
<th>Mechanism</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Authentication</td>
<td>JWT — hard error on invalid/missing token</td>
</tr>
<tr class="even">
<td>Validation</td>
<td>Zod schemas on all request bodies</td>
</tr>
<tr class="odd">
<td>Rate Limiting</td>
<td>Per-IP, per-path (Flash: 60/min, Pro: 15/min)</td>
</tr>
<tr class="even">
<td>Input Limits</td>
<td>productDocs: 500K chars, prompt: 10K chars</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="model-profile-system">3. Model Profile System</h2>
<p>Controlled by <code>MODEL_PROFILE</code> env var. Every model call
logs the actual model name and emits it via pipeline step events for UI
visibility.</p>
<table>
<thead>
<tr class="header">
<th>Task</th>
<th>Production</th>
<th>Test</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>flash</td>
<td>gemini-3-flash-preview</td>
<td>gemini-2.5-flash</td>
</tr>
<tr class="even">
<td>pro</td>
<td>gemini-3-pro-preview</td>
<td>gemini-2.5-flash</td>
</tr>
<tr class="odd">
<td>deepResearch</td>
<td>deep-research-pro-preview-12-2025</td>
<td>gemini-2.5-flash</td>
</tr>
<tr class="even">
<td>generation</td>
<td>gemini-3-pro-preview</td>
<td>gemini-2.5-flash</td>
</tr>
<tr class="odd">
<td>scoring</td>
<td>gemini-3-flash-preview</td>
<td>gemini-2.5-flash</td>
</tr>
<tr class="even">
<td>deslop</td>
<td>gemini-3-pro-preview</td>
<td>gemini-2.5-flash</td>
</tr>
</tbody>
</table>
<p>Test profile uses a single cheap model for all tasks — ideal for
development and CI.</p>
<hr />
<h2 id="quality-scoring-system">4. Quality Scoring System</h2>
<p>5 independent scorers run in parallel via
<code>Promise.all</code>:</p>
<table>
<colgroup>
<col style="width: 18%" />
<col style="width: 16%" />
<col style="width: 25%" />
<col style="width: 39%" />
</colgroup>
<thead>
<tr class="header">
<th>Scorer</th>
<th>Scale</th>
<th>Direction</th>
<th>What It Measures</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Slop</td>
<td>0-10</td>
<td>Lower is better</td>
<td>AI clichés, filler phrases</td>
</tr>
<tr class="even">
<td>Vendor Speak</td>
<td>0-10</td>
<td>Lower is better</td>
<td>Marketing jargon, buzzwords</td>
</tr>
<tr class="odd">
<td>Authenticity</td>
<td>0-10</td>
<td>Higher is better</td>
<td>Genuine practitioner voice</td>
</tr>
<tr class="even">
<td>Specificity</td>
<td>0-10</td>
<td>Higher is better</td>
<td>Concrete details vs vague claims</td>
</tr>
<tr class="odd">
<td>Persona</td>
<td>0-10</td>
<td>Higher is better</td>
<td>Fit with target persona</td>
</tr>
</tbody>
</table>
<h3 id="scorer-health-degraded-mode">Scorer Health &amp; Degraded
Mode</h3>
<p>Each scoring run tracks health:
<code>{ succeeded: N, failed: [...], total: 5 }</code>.</p>
<p>If a scorer throws, it returns a neutral fallback score of 5 and the
failure is logged. The system continues in degraded mode rather than
failing the entire job. Health is visible in the pipeline step UI.</p>
<h3 id="quality-gates-per-voice-thresholds">Quality Gates (Per-Voice
Thresholds)</h3>
<table>
<thead>
<tr class="header">
<th>Gate</th>
<th>Default</th>
<th>Direction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>slopMax</td>
<td>5</td>
<td>Reject if above</td>
</tr>
<tr class="even">
<td>vendorSpeakMax</td>
<td>5</td>
<td>Reject if above</td>
</tr>
<tr class="odd">
<td>authenticityMin</td>
<td>6</td>
<td>Reject if below</td>
</tr>
<tr class="even">
<td>specificityMin</td>
<td>6</td>
<td>Reject if below</td>
</tr>
<tr class="odd">
<td>personaMin</td>
<td>6</td>
<td>Reject if below</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="pipelines">5. Pipelines</h2>
<p>All pipelines follow a sequential DAG pattern. Each step feeds the
next — no branching.</p>
<h3 id="standard-pipeline">5.1 Standard Pipeline</h3>
<p><strong>PoV-first — extract a deep product thesis before
generating.</strong></p>
<pre><code>Deep PoV Extraction (Pro)
  → Insight Extraction (Flash)
  → Community Research (Deep Research)
  → Competitive Research (Deep Research)
  → For each assetType × voice:
      → Generate with PoV-first prompt (Pro)
      → Score → Refinement Loop (up to 3x) → Store</code></pre>
<h3 id="outside-in-pipeline-signature">5.2 Outside-In Pipeline
(Signature)</h3>
<p><strong>Community pain-first — start with real practitioner
frustrations.</strong></p>
<pre><code>Insight Extraction (Flash)
  → Community Deep Research (Deep Research)
  → Competitive Research (Deep Research)
  → For each assetType × voice:
      → Generate with pain-first prompt (Pro)
      → Score → Refinement Loop (up to 3x) → Store</code></pre>
<h3 id="adversarial-pipeline">5.3 Adversarial Pipeline</h3>
<p><strong>Attack/defend — generate objections, then craft messaging
that survives them.</strong></p>
<pre><code>Insight Extraction (Flash)
  → Research (Deep Research)
  → For each assetType × voice:
      → Generate attack (hostile buyer objections)
      → Generate defense (messaging addressing attacks)
      → Score defense → Refinement Loop (up to 3x) → Store</code></pre>
<h3 id="multi-perspective-pipeline">5.4 Multi-Perspective Pipeline</h3>
<p><strong>3 angles + synthesis — practitioner, buyer, executive
perspectives merged.</strong></p>
<pre><code>Insight Extraction (Flash)
  → Research (Deep Research)
  → For each assetType × voice:
      → Generate Practitioner angle
      → Generate Buyer angle
      → Generate Executive angle
      → Synthesize into unified content
      → Score → Refinement Loop (up to 3x) → Store</code></pre>
<h3 id="straight-through-pipeline">5.5 Straight Through Pipeline</h3>
<p><strong>Score-only — evaluate existing content without any
generation.</strong></p>
<pre><code>Insight Extraction (Flash)
  → For each assetType × voice:
      → Score existing content (5 scorers)
      → Store (original content preserved as-is)</code></pre>
<p><strong>Key differences:</strong> - NO generation — content is never
rewritten - NO refinement loop — no deslop, no iteration - NO research
phase - Requires <code>existingMessaging</code> — fails if not
provided</p>
<p><strong>Use case:</strong> Benchmarking existing marketing
content.</p>
<hr />
<h2 id="shared-pipeline-components">6. Shared Pipeline Components</h2>
<h3 id="refinement-loop">Refinement Loop</h3>
<ol type="1">
<li>Score with 5 scorers</li>
<li>If quality gates pass → done</li>
<li>Deslop to remove AI clichés</li>
<li>Build refinement prompt with score feedback</li>
<li>Regenerate</li>
<li>Rescore — stop if plateau detected</li>
<li>Repeat up to 3 times</li>
</ol>
<h3 id="evidence-bundle">Evidence Bundle</h3>
<p>Community and competitive research packaged as
<code>EvidenceBundle</code>: - <code>communityPain</code> — real
developer frustrations - <code>competitorWeaknesses</code> — positioning
gaps - <code>practitionerQuotes</code> — attributed quotes with source
URLs - <code>evidenceLevel</code> — <code>strong</code> |
<code>moderate</code> | <code>weak</code></p>
<hr />
<h2 id="api-reference">7. API Reference</h2>
<h3 id="core-endpoints">Core Endpoints</h3>
<table>
<thead>
<tr class="header">
<th>Method</th>
<th>Path</th>
<th>Auth</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>POST</td>
<td><code>/api/generate</code></td>
<td>JWT</td>
<td>Start generation job</td>
</tr>
<tr class="even">
<td>GET</td>
<td><code>/api/voices</code></td>
<td>JWT</td>
<td>List voice profiles</td>
</tr>
<tr class="odd">
<td>POST</td>
<td><code>/api/extract</code></td>
<td>JWT</td>
<td>Extract document content</td>
</tr>
<tr class="even">
<td>POST</td>
<td><code>/api/auth/login</code></td>
<td>—</td>
<td>Get JWT token</td>
</tr>
<tr class="odd">
<td>POST</td>
<td><code>/api/auth/signup</code></td>
<td>—</td>
<td>Create account</td>
</tr>
</tbody>
</table>
<h3 id="generate-request-schema">Generate Request Schema</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;productDocs&quot;</span><span class="fu">:</span> <span class="st">&quot;string (required, max 500K)&quot;</span><span class="fu">,</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;existingMessaging&quot;</span><span class="fu">:</span> <span class="st">&quot;string (optional, max 500K)&quot;</span><span class="fu">,</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;prompt&quot;</span><span class="fu">:</span> <span class="st">&quot;string (optional, max 10K)&quot;</span><span class="fu">,</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;voiceProfileIds&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;string (min 1)&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;assetTypes&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;battlecard | talk_track | launch_messaging | social_hook | one_pager | email_copy | messaging_template | narrative&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;model&quot;</span><span class="fu">:</span> <span class="st">&quot;string (optional)&quot;</span><span class="fu">,</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;pipeline&quot;</span><span class="fu">:</span> <span class="st">&quot;standard | outside-in | adversarial | multi-perspective | straight-through&quot;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h3 id="asset-types">Asset Types</h3>
<table>
<thead>
<tr class="header">
<th>Type</th>
<th>Label</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>battlecard</td>
<td>Battlecard</td>
</tr>
<tr class="even">
<td>talk_track</td>
<td>Talk Track</td>
</tr>
<tr class="odd">
<td>launch_messaging</td>
<td>Launch Messaging</td>
</tr>
<tr class="even">
<td>social_hook</td>
<td>Social Hook</td>
</tr>
<tr class="odd">
<td>one_pager</td>
<td>One-Pager</td>
</tr>
<tr class="even">
<td>email_copy</td>
<td>Email Copy</td>
</tr>
<tr class="odd">
<td>messaging_template</td>
<td>Messaging Template</td>
</tr>
<tr class="even">
<td>narrative</td>
<td>Narrative</td>
</tr>
</tbody>
</table>
</body>
</html>
